# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン | 選定理由 |
|------|-----------|----------|
| Node.js | v24.13.0 | 最新LTS。非同期I/O処理に優れ、フロントエンド・バックエンド統一の開発環境を実現。npmエコシステムが充実 |
| TypeScript | 5.x | 静的型付けによりコンパイル時にバグを検出。IDE補完が強力で開発効率向上。フロント・バック両方で型定義を共有可能 |
| npm | 11.x | Node.js v24に標準搭載。workspaces機能でモノレポ構成に対応。package-lock.jsonで依存関係を厳密管理 |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Vue.js | 3.x | フロントエンドUI | ユーザーが精通。Composition APIによるリアクティブなUI構築。軽量で高速 |
| Vite | 5.x | フロントエンドビルド | 高速なHMR（Hot Module Replacement）。Vue 3との相性が良く、設定が簡潔 |
| Hono | 4.x | バックエンドAPI | TypeScript完全対応。軽量（依存なし）で高速。Web標準準拠でテストしやすい |
| OpenAI SDK | 4.x | AI機能連携 | 公式SDK。TypeScript型定義完備。ストリーミング対応 |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Vitest | 2.x | ユニットテスト | Viteネイティブ。高速で設定不要。Jest互換API |
| Playwright | 1.x | E2Eテスト | クロスブラウザ対応。安定したAPI。MCPで既に設定済み |
| ESLint | 9.x | コード品質 | TypeScript対応。flat config形式で設定が明確 |
| Prettier | 3.x | コードフォーマット | 一貫したコードスタイル。ESLintと統合可能 |

## アーキテクチャパターン

### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                       クライアント（ブラウザ）                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Vue.js SPA                           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │  Views   │  │  Store   │  │ Composables│             │   │
│  │  └──────────┘  └──────────┘  └──────────┘              │   │
│  │                      │                                   │   │
│  │              ┌───────┴───────┐                          │   │
│  │              │  API Client   │                          │   │
│  │              └───────────────┘                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │ HTTP
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      バックエンド（Hono）                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    API Router                           │   │
│  │  /api/news  /api/text  /api/tts  /api/speech  /api/log │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Service Layer                         │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐          │   │
│  │  │NewsService │ │TextService │ │TTSService  │          │   │
│  │  └────────────┘ └────────────┘ └────────────┘          │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐          │   │
│  │  │SpeechService│ │FeedbackSvc │ │LogService  │          │   │
│  │  └────────────┘ └────────────┘ └────────────┘          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   External Adapters                     │   │
│  │  ┌────────────┐ ┌────────────┐                         │   │
│  │  │OpenAI Client│ │FileStorage │                         │   │
│  │  └────────────┘ └────────────┘                         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │ OpenAI   │   │  Local   │   │  Local   │
        │   API    │   │  Files   │   │  Audio   │
        └──────────┘   │  (logs/) │   │  Files   │
                       └──────────┘   └──────────┘
```

### レイヤードアーキテクチャ

```
┌─────────────────────────────────────────┐
│   UIレイヤー（Vue.js）                   │ ← ユーザー入力の受付と表示
│   - Views: 画面コンポーネント            │
│   - Composables: 再利用ロジック          │
│   - Store: 状態管理                      │
├─────────────────────────────────────────┤
│   APIレイヤー（Hono Router）             │ ← HTTPリクエスト/レスポンス処理
│   - ルーティング                         │
│   - リクエストバリデーション             │
│   - エラーハンドリング                   │
├─────────────────────────────────────────┤
│   サービスレイヤー                       │ ← ビジネスロジック
│   - ドメインロジック                     │
│   - 外部サービス連携                     │
│   - データ変換                          │
├─────────────────────────────────────────┤
│   アダプターレイヤー                     │ ← 外部依存の抽象化
│   - OpenAI Client                       │
│   - File Storage                        │
└─────────────────────────────────────────┘
```

#### UIレイヤー（フロントエンド）
- **責務**: ユーザー入力の受付、バリデーション、結果の表示
- **許可される操作**: APIレイヤーへのHTTPリクエスト
- **禁止される操作**: サービスレイヤー・アダプターへの直接アクセス

#### APIレイヤー（バックエンド）
- **責務**: HTTPリクエストの受付、レスポンスの整形、エラーハンドリング
- **許可される操作**: サービスレイヤーの呼び出し
- **禁止される操作**: 外部サービスへの直接アクセス

#### サービスレイヤー（バックエンド）
- **責務**: ビジネスロジックの実装、データ変換
- **許可される操作**: アダプターレイヤーの呼び出し
- **禁止される操作**: HTTPリクエスト/レスポンスの直接操作

#### アダプターレイヤー（バックエンド）
- **責務**: 外部依存の抽象化（OpenAI API、ファイルシステム）
- **許可される操作**: 外部サービス・ファイルシステムへのアクセス
- **禁止される操作**: ビジネスロジックの実装

## プロジェクト構造

```
daily-english-gym/
├── package.json              # ルートpackage.json（workspaces定義）
├── packages/
│   ├── frontend/             # Vue.js フロントエンド
│   │   ├── package.json
│   │   ├── vite.config.ts
│   │   ├── index.html
│   │   └── src/
│   │       ├── main.ts
│   │       ├── App.vue
│   │       ├── router/       # Vue Router設定
│   │       │   └── index.ts
│   │       ├── views/        # 画面コンポーネント
│   │       │   ├── HomeView.vue
│   │       │   ├── InputView.vue
│   │       │   ├── UnderstandView.vue
│   │       │   ├── SpeakView.vue
│   │       │   └── ReflectView.vue
│   │       ├── components/   # 共通UIコンポーネント
│   │       │   ├── AudioPlayer.vue
│   │       │   ├── AudioRecorder.vue
│   │       │   └── LoadingSpinner.vue
│   │       ├── composables/  # 再利用ロジック
│   │       │   ├── useAudioRecorder.ts
│   │       │   └── useApi.ts
│   │       ├── stores/       # Pinia状態管理
│   │       │   └── session.ts
│   │       ├── types/        # 型定義
│   │       │   └── index.ts
│   │       └── styles/       # グローバルスタイル
│   │           └── main.css
│   │
│   ├── backend/              # Hono バックエンド
│   │   ├── package.json
│   │   └── src/
│   │       ├── index.ts      # エントリーポイント
│   │       ├── routes/       # APIルート定義
│   │       │   ├── news.ts
│   │       │   ├── text.ts
│   │       │   ├── tts.ts
│   │       │   ├── speech.ts
│   │       │   ├── feedback.ts
│   │       │   └── log.ts
│   │       ├── services/     # ビジネスロジック
│   │       │   ├── NewsService.ts
│   │       │   ├── TextGenService.ts
│   │       │   ├── TTSService.ts
│   │       │   ├── SpeechService.ts
│   │       │   ├── FeedbackService.ts
│   │       │   └── LogService.ts
│   │       ├── adapters/     # 外部依存アダプター
│   │       │   ├── OpenAIClient.ts
│   │       │   └── FileStorage.ts
│   │       ├── types/        # 型定義
│   │       │   └── index.ts
│   │       └── utils/        # ユーティリティ
│   │           └── retry.ts
│   │
│   └── shared/               # 共有型定義
│       ├── package.json
│       └── src/
│           └── types.ts      # フロント・バック共通の型
│
├── logs/                     # 学習ログ保存先
│   └── YYYY-MM/
│       ├── YYYY-MM-DD.md
│       └── YYYY-MM-DD-audio.webm
│
├── docs/                     # ドキュメント
├── .env.example              # 環境変数テンプレート
└── .env                      # 環境変数（gitignore）
```

## データ永続化戦略

### ストレージ方式

| データ種別 | ストレージ | フォーマット | 理由 |
|-----------|----------|-------------|------|
| 学習ログ | ローカルファイル | Markdown | 人間が読める形式。Git管理可能。エディタで直接編集可能 |
| 音声ファイル | ローカルファイル | WebM | ブラウザ標準。圧縮率が高く、ファイルサイズを抑制 |
| セッション状態 | メモリ（Pinia） | - | 一時的な状態。永続化不要 |

### ファイル保存パス

```
logs/
├── 2025-01/
│   ├── 2025-01-20.md         # 学習ログ（Markdown）
│   ├── 2025-01-20-1.webm     # 音声ファイル（セッション1）
│   ├── 2025-01-20-2.webm     # 音声ファイル（セッション2）
│   ├── 2025-01-21.md
│   └── 2025-01-21-1.webm
└── 2025-02/
    └── ...
```

### バックアップ戦略

- **頻度**: 手動（Git commit）
- **保存先**: Gitリポジトリ（ログファイルはGit管理対象）
- **世代管理**: Gitの履歴で管理
- **復元方法**: `git checkout` で任意の時点に復元

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定環境 | 備考 |
|------|---------|---------|------|
| 画面遷移 | 100ms以内 | ローカル | Vue Router遷移 |
| API応答（ログ保存等） | 500ms以内 | ローカル | OpenAI API呼び出し除く |
| Level 1/2/3テキスト生成 | 10秒以内 | OpenAI API | GPT-5.2依存 |
| TTS音声生成開始 | 5秒以内 | OpenAI API | ストリーミング開始まで |
| 音声文字起こし | 10秒以内 | OpenAI API | 1分以内の音声 |
| フィードバック生成 | 10秒以内 | OpenAI API | GPT-5.2依存 |

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| メモリ（フロント） | 256MB | ブラウザタブの一般的な上限 |
| メモリ（バック） | 512MB | Node.jsプロセス |
| ディスク（年間） | 10GB | 音声ファイル中心。365日 × 約30MB/日 |

## セキュリティアーキテクチャ

### データ保護

| 項目 | 対策 |
|------|------|
| APIキー管理 | `.env`ファイルで管理。環境変数経由でバックエンドのみ参照 |
| クライアント露出防止 | APIキーはバックエンド内のみ。フロントエンドには一切露出しない |
| ファイルパーミッション | `.env`は600（所有者のみ読み書き） |

### 入力検証

| 項目 | 対策 |
|------|------|
| テキスト入力 | 最大文字数制限（10,000文字）。XSS対策としてエスケープ |
| ファイルパス | パストラバーサル攻撃防止。`logs/`配下のみアクセス許可 |
| 音声ファイル | ファイルサイズ上限（10MB）。MIMEタイプ検証 |

### ネットワーク

| 項目 | 対策 |
|------|------|
| アクセス制限 | localhost（127.0.0.1）からのみアクセス許可 |
| CORS | 同一オリジンポリシー。クロスオリジンリクエスト拒否 |

## スケーラビリティ設計

### データ増加への対応

- **想定データ量**: 年間365ファイル（ログ）+ 約365個の音声ファイル
- **パフォーマンス劣化対策**: 月別ディレクトリ分割によりファイル数を分散
- **アーカイブ戦略**: 年単位でアーカイブ（手動）。必要に応じて古いログを別ディレクトリに移動

### 機能拡張性

| 項目 | 設計 |
|------|------|
| 新規APIエンドポイント | Honoのルートファイルを追加するだけで拡張可能 |
| 新規サービス | サービスレイヤーにクラスを追加。依存注入で差し替え可能 |
| 外部サービス変更 | アダプターレイヤーで抽象化。OpenAI以外のLLMにも対応可能 |

## テスト戦略

### ユニットテスト

| 項目 | 内容 |
|------|------|
| フレームワーク | Vitest |
| 対象 | サービスレイヤー、ユーティリティ関数 |
| カバレッジ目標 | 80%（サービスレイヤー） |
| モック | OpenAI APIはモック化。ファイルシステムはインメモリ実装 |

### 統合テスト

| 項目 | 内容 |
|------|------|
| 対象 | APIエンドポイント |
| 方法 | Honoのテストクライアントを使用 |
| 検証内容 | リクエスト/レスポンス形式、エラーハンドリング |

### E2Eテスト

| 項目 | 内容 |
|------|------|
| ツール | Playwright |
| シナリオ | 学習フロー全体（入力→理解→スピーキング→フィードバック→保存） |
| 実行環境 | Chrome（ヘッドレス） |

## 技術的制約

### 環境要件

| 項目 | 要件 |
|------|------|
| OS | Windows 10/11, macOS 12+, Linux（Ubuntu 22.04+） |
| ブラウザ | Chrome 120+（デスクトップ版のみ） |
| Node.js | v24.13.0以上 |
| メモリ | 最小4GB（推奨8GB） |
| ディスク | 最小1GB空き容量（推奨10GB） |
| ネットワーク | OpenAI APIへの接続が必要 |

### パフォーマンス制約

- OpenAI APIのレート制限に依存（TPM/RPM）
- 音声録音はブラウザのMediaRecorder APIに依存
- TTS音声の長さはOpenAI APIの制限に依存

### セキュリティ制約

- OpenAI APIキーが必要（有料）
- ローカル実行のみ（インターネット公開非対応）
- 認証機能なし（シングルユーザー前提）

## 依存関係管理

### 本番依存（dependencies）

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| vue | フロントエンドフレームワーク | ^3.x（マイナーバージョンまで自動） |
| vue-router | ルーティング | ^4.x |
| pinia | 状態管理 | ^2.x |
| hono | バックエンドフレームワーク | ^4.x |
| openai | OpenAI SDK | ^4.x |

### 開発依存（devDependencies）

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| typescript | 型システム | ~5.x（パッチのみ自動） |
| vite | ビルドツール | ^5.x |
| vitest | テストフレームワーク | ^2.x |
| @playwright/test | E2Eテスト | ^1.x |
| eslint | リンター | ^9.x |
| prettier | フォーマッター | ^3.x |

### バージョン管理方針

- **安定版ライブラリ**: `^`（キャレット）でマイナーバージョンまで自動更新
- **破壊的変更リスクあり**: 完全固定（バージョン番号のみ）
- **開発ツール**: `~`（チルダ）でパッチバージョンのみ自動更新

## エラーハンドリング戦略

### エラー分類

| カテゴリ | 例 | 対応 |
|---------|---|------|
| バリデーションエラー | 空入力、文字数超過 | 即座にユーザーに通知。処理中断 |
| 外部APIエラー | OpenAI API障害 | 1回リトライ後、エラーメッセージ表示 |
| レート制限 | OpenAI TPM/RPM超過 | 待機後リトライ。ユーザーに待機中を通知 |
| ファイルシステムエラー | 書き込み失敗 | リトライ。失敗時はエラー通知 |
| ネットワークエラー | 接続断 | リトライ。失敗時は接続確認を促す |

### リトライ設定

```typescript
const RETRY_CONFIG = {
  maxRetries: 1,           // 最大リトライ回数
  retryDelay: 1000,        // リトライ間隔（ms）
  rateLimitDelay: 5000,    // レート制限時の待機時間（ms）
};
```

## 開発環境セットアップ

### 必要な環境変数

```bash
# .env.example
OPENAI_API_KEY=sk-xxxxxxxxxxxx  # OpenAI APIキー（必須）
PORT=3000                        # バックエンドポート（デフォルト: 3000）
```

### 起動コマンド

```bash
# 依存関係インストール
npm install

# 開発サーバー起動（フロント + バック同時）
npm run dev

# フロントエンドのみ
npm run dev:frontend

# バックエンドのみ
npm run dev:backend

# テスト実行
npm run test

# E2Eテスト実行
npm run test:e2e

# ビルド
npm run build
```
